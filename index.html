<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>English Learning App</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      max-width: 720px;
      margin: auto;
    }

    h2, h3 {
      margin-top: 16px;
    }

    input, textarea, select, button {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      font-size: 15px;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
    }

    .toolbar, .row {
      display: flex;
      gap: 6px;
    }

    .toolbar button,
    .row button {
      flex: 1;
    }

    .card {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
    }

    .en {
      color: #0077cc;
      margin-top: 6px;
    }

    #searchInput {
      padding: 10px;
      margin: 12px 0;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>

<h2>ğŸ“˜ English Learning App</h2>

<div class="toolbar">
  <button onclick="exportData()">ğŸ“¤ Xuáº¥t bÃ i há»c</button>
  <button onclick="importData()">ğŸ“¥ Nháº­p bÃ i há»c</button>
</div>

<h3>â• / âœï¸ ThÃªm â€“ Sá»­a cÃ¢u</h3>

<input id="structureInput" placeholder="Cáº¥u trÃºc (VD: There is / There are)" />
<input id="groupInput" placeholder="NhÃ³m (VD: Trong nhÃ )" />
<textarea id="viInput" placeholder="CÃ¢u tiáº¿ng Viá»‡t"></textarea>
<textarea id="enInput" placeholder="CÃ¢u tiáº¿ng Anh"></textarea>

<button onclick="saveSentence()">ğŸ’¾ LÆ°u cÃ¢u</button>
<button onclick="cancelEdit()" id="cancelBtn" style="display:none;">âŒ Huá»· sá»­a</button>

<hr>

<h3>ğŸ“‚ Ã”n táº­p</h3>

<input
  type="text"
  id="searchInput"
  placeholder="ğŸ” TÃ¬m cÃ¢u (Viá»‡t / Anh / cáº¥u trÃºc / nhÃ³m)"
  oninput="renderList()"
/>

<div class="row">
  <button onclick="shuffleList()">ğŸ”€ Trá»™n cÃ¢u</button>
  <button onclick="resetOrder()">â†©ï¸ Thá»© tá»± gá»‘c</button>
</div>

<select id="structureFilter" onchange="updateGroups()"></select>
<select id="groupFilter" onchange="renderList()"></select>

<div id="list"></div>

<input type="file" id="fileInput" accept=".json" style="display:none" />

<script>
/* ===== CONFIG ===== */
const STORAGE_KEY = "english_sentences";

/* ===== STATE ===== */
let editIndex = null;
let shuffledData = null;

/* ===== DATA ===== */
function getData() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ===== CRUD ===== */
function saveSentence() {
  const structure = structureInput.value.trim();
  const group = groupInput.value.trim();
  const vi = viInput.value.trim();
  const en = enInput.value.trim();

  if (!structure || !group || !vi || !en) {
    alert("Nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin");
    return;
  }

  const data = getData();

  if (editIndex !== null) {
    data[editIndex] = { structure, group, vi, en };
    editIndex = null;
    cancelBtn.style.display = "none";
  } else {
    data.push({ structure, group, vi, en });
  }

  saveData(data);
  shuffledData = null;

  viInput.value = "";
  enInput.value = "";

  loadFilters();
  renderList();
}

function editSentence(i) {
  const s = getData()[i];
  structureInput.value = s.structure;
  groupInput.value = s.group;
  viInput.value = s.vi;
  enInput.value = s.en;
  editIndex = i;
  cancelBtn.style.display = "block";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function cancelEdit() {
  editIndex = null;
  viInput.value = "";
  enInput.value = "";
  cancelBtn.style.display = "none";
}

function deleteSentence(i) {
  if (!confirm("XoÃ¡ cÃ¢u nÃ y?")) return;
  const data = getData();
  data.splice(i, 1);
  saveData(data);
  shuffledData = null;
  loadFilters();
  renderList();
}

/* ===== FILTER ===== */
function loadFilters() {
  const data = getData();
  const structures = [...new Set(data.map(s => s.structure))];

  structureFilter.innerHTML =
    `<option value="">-- Táº¥t cáº£ cáº¥u trÃºc --</option>` +
    structures.map(s => `<option>${s}</option>`).join("");

  groupFilter.innerHTML =
    `<option value="">-- Táº¥t cáº£ nhÃ³m --</option>`;
}

function updateGroups() {
  const data = getData();
  const structure = structureFilter.value;

  const groups = [...new Set(
    data.filter(s => !structure || s.structure === structure)
        .map(s => s.group)
  )];

  groupFilter.innerHTML =
    `<option value="">-- Táº¥t cáº£ nhÃ³m --</option>` +
    groups.map(g => `<option>${g}</option>`).join("");

  renderList();
}

/* ===== SHUFFLE ===== */
function shuffleList() {
  const data = getData();
  shuffledData = [...data];

  for (let i = shuffledData.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledData[i], shuffledData[j]] = [shuffledData[j], shuffledData[i]];
  }

  renderList();
}

function resetOrder() {
  shuffledData = null;
  renderList();
}

/* ===== RENDER ===== */
function renderList() {
  const data = shuffledData || getData();
  const structure = structureFilter.value;
  const group = groupFilter.value;
  const keyword = searchInput.value.toLowerCase();

  list.innerHTML = "";

  data.forEach((s, i) => {
    if (
      keyword &&
      !(
        s.vi.toLowerCase().includes(keyword) ||
        s.en.toLowerCase().includes(keyword) ||
        s.structure.toLowerCase().includes(keyword) ||
        s.group.toLowerCase().includes(keyword)
      )
    ) return;

    if ((structure && s.structure !== structure) ||
        (group && s.group !== group)) return;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${s.vi}</b>
      <div class="row">
        <button onclick="speak('${s.en.replace(/'/g,"\\'")}')">ğŸ”Š Nghe</button>
        <button onclick="toggleEn(${i})">ğŸ‘ Hiá»‡n / áº¨n EN</button>
        <button onclick="editSentence(${i})">âœï¸ Sá»­a</button>
        <button onclick="deleteSentence(${i})">ğŸ—‘ XoÃ¡</button>
      </div>
      <div class="en" id="en-${i}" hidden>${s.en}</div>
    `;
    list.appendChild(div);
  });
}

/* ===== UTILS ===== */
function toggleEn(i) {
  const el = document.getElementById("en-" + i);
  if (el) el.hidden = !el.hidden;
}

function speak(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== IMPORT / EXPORT ===== */
function exportData() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (!data) return alert("KhÃ´ng cÃ³ dá»¯ liá»‡u");
  const blob = new Blob([data], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "english_sentences.json";
  a.click();
}

function importData() {
  fileInput.value = "";
  fileInput.click();
}

fileInput.addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const json = JSON.parse(e.target.result);
      if (!Array.isArray(json)) throw "";
      if (!confirm("Ghi Ä‘Ã¨ toÃ n bá»™ dá»¯ liá»‡u hiá»‡n táº¡i?")) return;
      saveData(json);
      shuffledData = null;
      loadFilters();
      renderList();
    } catch {
      alert("File khÃ´ng há»£p lá»‡");
    }
  };
  reader.readAsText(file);
});

/* ===== INIT ===== */
loadFilters();
renderList();
</script>

</body>
</html>
